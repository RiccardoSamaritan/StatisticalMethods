---
title: "BikeSharing_Trees"
author: "Lorenzo Tonet, Giovanni Oro, Riccardo Samaritan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/STORAGE/UNI/MAGISTRALE/STAT METHODS/FINAL PROJECT/BikeSharing")

library(corrplot)
library(patchwork)
library(ggplot2)
library(mgcv)
library(ggridges)
library(MASS)
library(rpart)
library(rpart.plot)

```


```{r data_import}
df = read.csv("hour.csv")
```

```{r summary}
df$season_f = factor(df$season, labels = c("Spring", "Summer", "Autumn","Winter"))
df$weather_f = factor(df$weathersit, labels = c("Clear", "Cloudy/Mist", "Light Snow/Rain", "Heavy Rain"))
df$workday_f = factor(df$workingday, labels = c("Weekend/Holiday", "Working day"))
df$hr_f = factor(df$hr)
df$weekday_f = factor(df$weekday)
df$yr_f = factor(df$yr, labels = c("2011","2012"))


levels(df$weather_f)[levels(df$weather_f) == "Heavy Rain"] = "Light Snow/Rain"
df$weather_f = droplevels(df$weather_f)
table(df$weather_f)
```

```{r train test split}
set.seed(6767)

train_id = sample(1:nrow(df), 0.75*nrow(df))
train = df[train_id, ]

test  = df[-train_id, ]
```

```{r baseline}
baseline_LineReg = lm(cnt ~ 
      hr+
      season_f +
      workday_f +
      weather_f +
      temp +
      yr_f +
      hum +
      windspeed,
      data = df)

summary(baseline_LineReg)
```

```{r tree}
tree_model <- rpart(cnt ~ 
      hr_f +
      season_f +
      workday_f +
      weather_f +
      temp +
      yr_f +
      hum +
      windspeed,
      data = train,
      method = "anova",
      control = rpart.control(cp = 0.001, minsplit = 10, maxdepth = 10))

rpart.plot(tree_model, type = 5, extra = 101, fallen.leaves = FALSE)

```

```{r pruning}
printcp(tree_model)
plotcp(tree_model)

best_cp = tree_model$cptable[which.min(tree_model$cptable[,"xerror"]), "CP"]

```


```{r pruned tree}
pruned_tree = prune(tree_model, cp = 0.012 )

rpart.plot(pruned_tree, type = 5, extra = 100, fallen.leaves = FALSE)
```

```{r}
png("plot_cp_high_res.png", 
    width = 2400,            # Larghezza in pixel
    height = 1800,           # Altezza in pixel
    res = 300)               # Risoluzione (300 DPI Ã¨ lo standard per la stampa)


rpart.plot(pruned_tree, type = 5, extra = 100, fallen.leaves = FALSE)

# 3. Chiudi il file (fondamentale per salvare!)
dev.off()
```

```{r random forest}
library(randomForest)

rf_model <- randomForest(cnt ~ 
      hr_f +
      season_f +
      workday_f +
      weather_f +
      temp +
      yr_f +
      hum +
      windspeed,
      data = train,
      ntree = 100,
      mtry = 3,
      importance = TRUE
)

```

```{r rf importance}
importance(rf_model)
varImpPlot(rf_model)

plot(rf_model, main = "MSE on OOB samples vs number of trees")
legend("topright", legend = "MSE", col = "black", lty = 1)
```
